<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>typing adventure (cute + sound)</title>

  <link href="https://fonts.googleapis.com/css2?family=Mochiy+Pop+One&family=Zen+Maru+Gothic:wght@500&display=swap" rel="stylesheet">

  <style>
    :root{
      --pink:#ff4aa2;
      --pink2:#ff86c7;
      --pink3:#ffb9df;
      --pink4:#ffe1f1;
      --shadow:#ffb3d9;
      --ink:#ff4aa2;

      --panel:#ffffffcc;
      --timebar:#ff82c3;
      --timebarBg:#ffe3f3;
    }
    *{ box-sizing:border-box; }

    body{
      margin:0;
      min-height:100svh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:16px;
      overflow:hidden;

      background:
        radial-gradient(#ffd3ea 1.2px, transparent 1.2px) 0 0/26px 26px,
        radial-gradient(#ffd3ea 1.2px, transparent 1.2px) 13px 13px/26px 26px,
        linear-gradient(180deg, #fff1f8, #ffe9f5);

      font-family: "Zen Maru Gothic", sans-serif;
      color: var(--ink);
    }

    body.has-bg::before{
      content:"";
      position:fixed;
      inset:0;
      background: url("./bg.png") center/contain no-repeat;
      opacity:0.22;
      filter:saturate(1.05);
      pointer-events:none;
    }

    .app{
      width:min(900px, 96vw);
      max-height:min(92svh, 980px);
      overflow:auto;
      padding:18px 18px 22px;
      border-radius:36px;
      background: var(--panel);
      border:6px solid var(--pink3);
      box-shadow: 0 18px 0 var(--shadow);
      backdrop-filter: blur(6px);
      position:relative;
    }

    @keyframes floaty{ from{transform:translateY(0)} to{transform:translateY(-6px)} }
    .floaty{ animation: floaty 1.6s ease-in-out infinite alternate; }
    @media (max-height: 720px){ .floaty{ animation:none; } }

    .top{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
      margin-bottom:10px;
    }

    .title{
      font-family:"Mochiy Pop One", sans-serif;
      font-size: clamp(22px, 4vw, 34px);
      color: var(--pink2);
      -webkit-text-stroke: 2px #fff;
      text-shadow: 3px 3px 0 #ffd2e8;
      margin:0;
      line-height:1.15;
    }

    .badge{
      font-family:"Mochiy Pop One", sans-serif;
      background:#fff;
      border:3px solid var(--pink3);
      border-radius:999px;
      padding:10px 14px;
      display:inline-flex;
      align-items:center;
      gap:10px;
      box-shadow: 0 6px 0 #ffd2e8;
      white-space:nowrap;
      font-size:14px;
    }
    .badge b{ font-size:18px; }

    .controls{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      justify-content:center;
      align-items:center;
      margin: 8px 0 10px;
    }

    select, input[type="number"], input[type="range"]{
      font-family:"Zen Maru Gothic", sans-serif;
      font-size:15px;
      padding:10px 12px;
      border-radius:999px;
      border:3px solid var(--pink3);
      background:#fff;
      color:var(--ink);
      outline:none;
    }
    select{ cursor:pointer; }

    .custom{
      display:none;
      gap:10px;
      flex-wrap:wrap;
      justify-content:center;
      align-items:center;
      margin-bottom: 8px;
    }
    .chip{
      background:#fff;
      border:3px solid var(--pink3);
      border-radius:999px;
      padding:8px 12px;
      display:inline-flex;
      align-items:center;
      gap:8px;
      font-size:14px;
    }
    .chip input[type="number"]{
      width:92px;
      border:2px solid var(--pink3);
      border-radius:999px;
      padding:6px 10px;
      font-size:14px;
    }
    .chip input[type="range"]{
      width:140px;
      padding:0;
      border:none;
    }

    .frame{
      background:#fff;
      border-radius: 30px;
      border: 6px solid #ffd7ec;
      box-shadow: inset 0 0 18px #ffeaf5;
      padding: 16px;
      position:relative;
    }

    .marquee{
      border-radius: 26px;
      border: 6px solid var(--pink3);
      box-shadow: 0 10px 0 #ffd2e8;
      padding: 16px;
      background: linear-gradient(180deg, #fff, #fff7fb);
      position:relative;
      overflow:hidden;
    }
    .marquee::before{
      content:"";
      position:absolute;
      inset:10px;
      border-radius: 18px;
      background: radial-gradient(#fff 2px, transparent 2px) 0 0/18px 18px;
      opacity:.45;
      pointer-events:none;
      mix-blend-mode: overlay;
    }

    .timebar-wrap{
      display:flex;
      align-items:center;
      gap:10px;
      justify-content:center;
      margin-bottom:12px;
    }
    .timebar{
      width:min(520px, 92%);
      height:16px;
      border-radius:999px;
      background: var(--timebarBg);
      border:3px solid var(--pink3);
      overflow:hidden;
      box-shadow: 0 6px 0 #ffd2e8;
    }
    .timebar > div{
      height:100%;
      width:100%;
      background: linear-gradient(90deg, #ffd1ea, var(--timebar));
      border-radius:999px;
      transform-origin:left center;
      transform: scaleX(1);
      transition: transform .12s linear;
    }
    .time-text{
      font-family:"Mochiy Pop One", sans-serif;
      font-size:14px;
      background:#fff;
      border:3px solid var(--pink3);
      border-radius:999px;
      padding:6px 10px;
      box-shadow: 0 6px 0 #ffd2e8;
      min-width:90px;
      text-align:center;
    }

    .word{
      font-family:"Mochiy Pop One", sans-serif;
      font-size: clamp(30px, 5.5vw, 56px);
      margin: 0;
      color: var(--pink);
      text-shadow:
        3px 3px 0 #fff, -3px -3px 0 #fff,
        3px -3px 0 #fff, -3px 3px 0 #fff;
      letter-spacing: 3px;
      line-height: 1.15;
      text-align:center;
    }

    .progress{
      margin-top: 10px;
      font-size: clamp(18px, 4.2vw, 28px);
      font-weight:900;
      letter-spacing:2px;
      min-height: 1.2em;
      user-select:none;
      display:flex;
      justify-content:center;
      flex-wrap:wrap;
    }
    .done{ color:#ffd1ea; }
    .todo{ color:#ff8ec7; }

    .hud{
      margin-top:10px;
      display:flex;
      justify-content:center;
      gap:10px;
      flex-wrap:wrap;
      font-family:"Mochiy Pop One", sans-serif;
    }
    .pill{
      background:#fff;
      border:3px solid var(--pink3);
      border-radius:999px;
      padding:8px 12px;
      box-shadow: 0 6px 0 #ffd2e8;
      font-size:14px;
      min-width:140px;
      text-align:center;
    }

    .message{
      margin-top:10px;
      font-family:"Mochiy Pop One", sans-serif;
      font-size:16px;
      min-height: 24px;
      text-align:center;
    }

    .pets{
      display:flex;
      justify-content:center;
      gap:14px;
      flex-wrap:wrap;
      margin-top: 14px;
    }
    .pet{
      width:86px;
      height:72px;
      display:grid;
      place-items:center;
      animation: bob 1.4s ease-in-out infinite alternate;
    }
    .pet:nth-child(2){ animation-duration: 1.55s; }
    .pet:nth-child(3){ animation-duration: 1.35s; }
    .pet:nth-child(4){ animation-duration: 1.6s; }
    .pet:nth-child(5){ animation-duration: 1.45s; }

    @keyframes bob{ from{ transform: translateY(0);} to{ transform: translateY(-6px);} }

    .pet.pop{ animation: pop .28s ease-out 1; }
    @keyframes pop{
      0%{ transform: translateY(0) scale(1); }
      50%{ transform: translateY(-10px) scale(1.12); }
      100%{ transform: translateY(0) scale(1); }
    }

    .shake{ animation: shake .18s ease-in-out 1; }
    @keyframes shake{
      0%,100%{ transform: translateX(0); }
      25%{ transform: translateX(-4px); }
      75%{ transform: translateX(4px); }
    }

    .buttons{
      display:flex;
      gap:10px;
      justify-content:center;
      margin-top: 14px;
      flex-wrap:wrap;
    }
    .btn{
      font-family:"Mochiy Pop One", sans-serif;
      border:none;
      border-radius:999px;
      padding: 14px 26px;
      font-size:18px;
      cursor:pointer;
      color:#fff;
      background: linear-gradient(180deg, var(--pink3), var(--pink2));
      box-shadow: 0 10px 0 #e65c99;
      transition: transform .08s;
      -webkit-text-stroke: 1px var(--pink);
    }
    .btn:active{
      transform: translateY(4px);
      box-shadow: 0 6px 0 #e65c99;
    }

    .heart{
      position:absolute;
      left:50%;
      top:65%;
      transform: translate(-50%, 0);
      pointer-events:none;
      opacity:0;
      animation: heartPop 900ms ease-out forwards;
      filter: drop-shadow(0 4px 0 rgba(255, 204, 230, 0.9));
      z-index:5;
    }
    @keyframes heartPop{
      0%   { opacity:0; transform: translate(-50%, 10px) scale(0.7) rotate(-6deg); }
      10%  { opacity:1; }
      60%  { opacity:1; transform: translate(calc(-50% + var(--dx)), -40px) scale(1.15) rotate(6deg); }
      100% { opacity:0; transform: translate(calc(-50% + var(--dx)), -95px) scale(1.25) rotate(10deg); }
    }

    #ime-input{
      position:absolute;
      left:-9999px;
      opacity:0;
    }

    .app::-webkit-scrollbar{ width: 10px; }
    .app::-webkit-scrollbar-track{ background: rgba(255,255,255,0.5); border-radius: 999px; }
    .app::-webkit-scrollbar-thumb{
      background: rgba(255,179,217,0.95);
      border-radius: 999px;
      border: 2px solid rgba(255,255,255,0.75);
    }
  </style>
</head>

<body class="has-bg">
  <div class="app floaty" id="app">
    <div class="top">
      <h1 class="title">TYPING ADVENTURE!</h1>
      <div class="badge">SCORE <b id="score">0</b></div>
    </div>

    <div class="controls">
      <select id="mode">
        <option value="easy">„ÅÑ„Éº„Åò„ÉºÔºà120„Å≥„Çá„ÅÜÔºè20„ÅîÔºâ</option>
        <option value="normal" selected>„ÅÆ„Éº„Åæ„ÇãÔºà120„Å≥„Çá„ÅÜÔºè30„ÅîÔºâ</option>
        <option value="hard">„ÅØ„Éº„Å©Ôºà120„Å≥„Çá„ÅÜÔºè40„ÅîÔºâ</option>
        <option value="extra">„Åà„Åè„Åô„Å®„ÇâÔºà120„Å≥„Çá„ÅÜÔºè50„ÅîÔºâ</option>
        <option value="custom">„Åã„Åô„Åü„ÇÄ</option>
      </select>

      <select id="category">
        <option value="sweets">„Åô„ÅÑ„Éº„Å§</option>
        <option value="oshikatsu">„Åä„Åó„Åã„Å§</option>
        <option value="daily">„Å´„Å°„Åò„Çá„ÅÜ</option>
        <option value="random" selected>„Çâ„Çì„Å†„ÇÄ</option>
      </select>
    </div>

    <div class="custom" id="custom">
      <span class="chip">„Åò„Åã„ÇìÔºà„Å≥„Çá„ÅÜÔºâ<input id="customTime" type="number" min="10" max="9999" value="120"></span>
      <span class="chip">„Åè„Çä„ÅÇ„Åî„Åô„ÅÜ<input id="customTarget" type="number" min="1" max="9999" value="30"></span>
      <span class="chip">„Åä„Å®„Çä„Çá„ÅÜ<input id="vol" type="range" min="0" max="100" value="45"></span>
    </div>

    <div class="frame">
      <div class="marquee" id="marquee">
        <div class="timebar-wrap">
          <div class="timebar"><div id="timeFill"></div></div>
          <div class="time-text"><span id="time">--</span>s</div>
        </div>

        <p class="word" id="word">Ôºà„Åò„Åó„Çá „Çà„Åø„Åì„Åø„Å°„ÇÖ„ÅÜÔºâ</p>
        <div class="progress">
          <span class="done" id="done"></span><span class="todo" id="todo"></span>
        </div>

        <div class="hud">
          <div class="pill">„Åè„Çä„ÅÇ: <span id="cleared">0</span> / <span id="target">--</span></div>
          <div class="pill">„Åø„Åô: <span id="miss">0</span></div>
          <div class="pill">„ÇÇ„Éº„Å©: <span id="modeLabel">--</span></div>
        </div>

        <div class="message" id="message"></div>
        <div class="pets" id="pets"></div>
      </div>

      <div class="buttons">
        <button class="btn" id="startBtn">„ÅÇ„Åù„Å≥„Å´„ÅÑ„ÅèÔºÅ</button>
        <button class="btn" id="toggleBgBtn">„ÅØ„ÅÑ„Åë„ÅÑ on/off</button>
        <button class="btn" id="muteBtn">„Åä„Å®: on</button>
        <button class="btn" id="testSeBtn">se „Å¶„Åô„Å®</button>
      </div>
    </div>

    <input id="ime-input" type="text" inputmode="text" autocomplete="off">
  </div>

<script>
  // ========= „ÇÇ„Éº„Å© =========
  const MODE_PRESETS = {
    easy:   { timeSec: 120, target: 20, label: "„ÅÑ„Éº„Åò„Éº" },
    normal: { timeSec: 120, target: 30, label: "„ÅÆ„Éº„Åæ„Çã" },
    hard:   { timeSec: 120, target: 40, label: "„ÅØ„Éº„Å©" },
    extra:  { timeSec: 120, target: 50, label: "„Åà„Åè„Åô„Å®„Çâ" }
  };

  // ========= DOM =========
  const app = document.getElementById("app");
  const marquee = document.getElementById("marquee");

  const scoreEl = document.getElementById("score");
  const timeEl = document.getElementById("time");
  const timeFill = document.getElementById("timeFill");

  const wordEl = document.getElementById("word");
  const doneEl = document.getElementById("done");
  const todoEl = document.getElementById("todo");

  const clearedEl = document.getElementById("cleared");
  const missEl = document.getElementById("miss");
  const targetEl = document.getElementById("target");
  const modeLabelEl = document.getElementById("modeLabel");
  const messageEl = document.getElementById("message");

  const petsEl = document.getElementById("pets");

  const modeEl = document.getElementById("mode");
  const categoryEl = document.getElementById("category");
  const customWrap = document.getElementById("custom");
  const customTimeEl = document.getElementById("customTime");
  const customTargetEl = document.getElementById("customTarget");
  const volEl = document.getElementById("vol");

  const startBtn = document.getElementById("startBtn");
  const toggleBgBtn = document.getElementById("toggleBgBtn");
  const muteBtn = document.getElementById("muteBtn");
  const testSeBtn = document.getElementById("testSeBtn");

  const imeInput = document.getElementById("ime-input");

  // ========= ËæûÊõ∏ =========
  let DICT = null;
  function cleanList(arr){
    const list = (Array.isArray(arr) ? arr : [])
      .map(s => String(s ?? "").trim())
      .filter(Boolean)
      .filter(s => /^[„ÅÅ-„Çñ„Éº]+$/.test(s))
      .filter(s => s.length >= 2 && s.length <= 14);
    return Array.from(new Set(list));
  }
  async function loadDictionary(){
    const res = await fetch("./dictionary.json", { cache: "no-store" });
    if(!res.ok) throw new Error("dictionary.json „Åå„Çà„ÇÅ„Å™„ÅÑ");
    const data = await res.json();
    DICT = {};
    for(const [k,v] of Object.entries(data)) DICT[k] = cleanList(v);
    const all = (DICT.sweets?.length ?? 0) + (DICT.oshikatsu?.length ?? 0) + (DICT.daily?.length ?? 0);
    if(all <= 0) throw new Error("dictionary „Åå„Åã„Çâ„Å£„ÅΩ");
  }
  function getPool(category){
    if(!DICT) return [];
    if(category === "random"){
      return [ ...(DICT.sweets ?? []), ...(DICT.oshikatsu ?? []), ...(DICT.daily ?? []) ];
    }
    return DICT[category] ?? [];
  }

  // ========= „Ç≠„É£„É©ÔºàË°®ÊÉÖ„Å§„ÅçSVGÔºâ =========
  const PET_COLORS = ["#bfe8ff","#ffe6a6","#c8f5d2","#ffd2f0","#ffe0c6"];
  const PET_LETTERS = ["A","B","B","E","C"];

  function petSVG(color, accent, letter){
    return `
    <svg width="86" height="72" viewBox="0 0 86 72" xmlns="http://www.w3.org/2000/svg">
      <defs>
        <filter id="s" x="-20%" y="-20%" width="140%" height="140%">
          <feDropShadow dx="0" dy="4" stdDeviation="0" flood-color="#ffd2e8" flood-opacity="1"/>
        </filter>
      </defs>
      <g filter="url(#s)">
        <path d="M13 36c-6 1-10 6-10 12 0 4 2 7 4 9 2 2 5 2 7 0 2-2 3-6 3-10 0-4-1-9-4-11z" fill="${accent}"/>
        <path d="M73 36c6 1 10 6 10 12 0 4-2 7-4 9-2 2-5 2-7 0-2-2-3-6-3-10 0-4 1-9 4-11z" fill="${accent}"/>

        <ellipse cx="43" cy="38" rx="30" ry="24" fill="${color}" stroke="#ffffff" stroke-width="4"/>
        <circle cx="26" cy="45" r="4" fill="#ff9fc8" opacity="0.8"/>
        <circle cx="60" cy="45" r="4" fill="#ff9fc8" opacity="0.8"/>

        <text x="43" y="22" text-anchor="middle" font-size="16"
              font-family="Mochiy Pop One, sans-serif"
              fill="#ff4aa2" stroke="#ffffff" stroke-width="3" paint-order="stroke">
          ${letter}
        </text>

        <g class="face face-normal">
          <circle cx="33" cy="38" r="4" fill="#7a3a5a"/>
          <circle cx="53" cy="38" r="4" fill="#7a3a5a"/>
          <path d="M40 46c2 2 4 2 6 0" stroke="#7a3a5a" stroke-width="3" stroke-linecap="round"/>
        </g>

        <g class="face face-happy" style="display:none">
          <path d="M29 38c2-4 6-4 8 0" stroke="#7a3a5a" stroke-width="3" fill="none" stroke-linecap="round"/>
          <path d="M49 38c2-4 6-4 8 0" stroke="#7a3a5a" stroke-width="3" fill="none" stroke-linecap="round"/>
          <path d="M38 46c3 4 7 4 10 0" stroke="#7a3a5a" stroke-width="3" fill="none" stroke-linecap="round"/>
        </g>

        <g class="face face-cry" style="display:none">
          <circle cx="33" cy="38" r="4" fill="#7a3a5a"/>
          <circle cx="53" cy="38" r="4" fill="#7a3a5a"/>
          <path d="M39 48c3-2 5-2 8 0" stroke="#7a3a5a" stroke-width="3" fill="none" stroke-linecap="round"/>
          <path d="M57 41c2 3 1 7-2 9c-3-2-4-6-2-9c1-2 3-2 4 0z" fill="#8fd3ff" opacity="0.9"/>
        </g>
      </g>
    </svg>`;
  }

  function renderPets(){
    petsEl.innerHTML = "";
    for(let i=0;i<5;i++){
      const wrap = document.createElement("div");
      wrap.className = "pet";
      const c = PET_COLORS[i % PET_COLORS.length];
      wrap.innerHTML = petSVG(c, "#fff1f8", PET_LETTERS[i] ?? "A");
      petsEl.appendChild(wrap);
    }
  }

  function popRandomPet(){
    const kids = [...petsEl.querySelectorAll(".pet")];
    if(kids.length === 0) return;
    const k = kids[Math.floor(Math.random()*kids.length)];
    k.classList.remove("pop");
    void k.offsetWidth;
    k.classList.add("pop");
  }

  function setPetFace(state, ms=420){
    const pets = [...document.querySelectorAll(".pet")];
    if(pets.length === 0) return;
    const p = pets[Math.floor(Math.random()*pets.length)];
    const svg = p.querySelector("svg");
    if(!svg) return;

    const normal = svg.querySelector(".face-normal");
    const happy  = svg.querySelector(".face-happy");
    const cry    = svg.querySelector(".face-cry");

    const show = (el, on)=>{ if(el) el.style.display = on ? "" : "none"; };
    show(normal, state==="normal");
    show(happy,  state==="happy");
    show(cry,    state==="cry");

    window.clearTimeout(p._faceTimer);
    p._faceTimer = window.setTimeout(()=>{
      show(normal,true); show(happy,false); show(cry,false);
    }, ms);
  }

  // ========= Èü≥Ôºà„Åì„Åì„ÅåÊú¨ÂëΩÔºâ =========
  const SOUND = {
    enabled: true,
    unlocked: false,
    volume: 0.45,

    bgm: new Audio("./sounds/bgm.mp3"),
    ok:  new Audio("./sounds/ok.wav"),
    miss:new Audio("./sounds/miss.wav")
  };

  // BGM„ÅØ„É´„Éº„Éó
  SOUND.bgm.loop = true;
  SOUND.bgm.preload = "auto";
  SOUND.ok.preload = "auto";
  SOUND.miss.preload = "auto";

  function applyVolume(){
    const v = SOUND.volume;
    SOUND.bgm.volume = v * 0.8;     // BGM„ÅØÂ∞ë„ÅóÂ∞è„Åï„ÇÅ
    SOUND.ok.volume  = Math.min(1, v * 1.0);
    SOUND.miss.volume= Math.min(1, v * 1.0);
  }

  // „Éñ„É©„Ç¶„Ç∂„ÅÆËá™ÂãïÂÜçÁîüË¶èÂà∂ÂØæÁ≠ñÔºö„É¶„Éº„Ç∂„ÉºÊìç‰Ωú„ÅÆÁû¨Èñì„Å´ ‚ÄúÁÑ°Èü≥„ÅßÂÜçÁîü‚ÜíÂç≥ÂÅúÊ≠¢‚Äù „Åó„Å¶Ëß£Á¶Å
  async function unlockAudio(){
    if(SOUND.unlocked) return;
    try{
      applyVolume();
      // ‰∏ÄÁû¨È≥¥„Çâ„Åó„Å¶Ê≠¢„ÇÅ„ÇãÔºà„Çº„É≠Áßí„ÅßÊ≠¢„ÇÅ„Çã„Å®Áí∞Â¢É„ÅßÂ§±Êïó„Åô„Çã„Åì„Å®„Åå„ÅÇ„Çã„ÅÆ„ÅßÂ∞ë„Åó„Å†„ÅëÔºâ
      SOUND.bgm.currentTime = 0;
      await SOUND.bgm.play();
      SOUND.bgm.pause();
      SOUND.bgm.currentTime = 0;

      SOUND.unlocked = true;
      // console.log("audio unlocked");
    }catch(e){
      // „Åì„Åì„ÅßÂ§±Êïó„Åó„Å¶„ÇÇ„ÄÅÊ¨°„ÅÆ„É¶„Éº„Ç∂„ÉºÊìç‰Ωú„ÅßÂÜçÊåëÊà¶„Åß„Åç„Çã
      // console.warn("unlock failed", e);
    }
  }

  async function playBGM(){
    if(!SOUND.enabled) return;
    await unlockAudio();
    try{
      applyVolume();
      await SOUND.bgm.play();
    }catch(e){
      // console.warn("bgm play failed", e);
    }
  }

  function stopBGM(){
    try{ SOUND.bgm.pause(); }catch{}
  }

  function playSE(which){
    if(!SOUND.enabled) return;
    // Âêå„ÅòAudio„ÇíÈÄ£Êâì„Åô„Çã„Å®È≥¥„Çâ„Å™„ÅÑ„Åì„Å®„Åå„ÅÇ„Çã„ÅÆ„Åß clone „ÅßÈ≥¥„Çâ„ÅôÔºàÊúÄÂº∑Ôºâ
    const base = SOUND[which];
    if(!base) return;
    const se = base.cloneNode(true);
    se.volume = base.volume;
    se.play().catch(()=>{});
  }

  function setSoundEnabled(on){
    SOUND.enabled = on;
    muteBtn.textContent = on ? "„Åä„Å®: on" : "„Åä„Å®: off";
    if(!on) stopBGM();
  }

  // ========= ÊºîÂá∫ =========
  function setMessage(t){ messageEl.textContent = t || ""; }

  function spawnHearts(count = 10){
    const hearts = ["‚ô°","‚ô•","‚ù§","üíó","üíñ","üíï","üíû","‚ô™","‚òÖ"];
    for(let i=0;i<count;i++){
      const el = document.createElement("div");
      el.className = "heart";
      el.textContent = hearts[Math.floor(Math.random()*hearts.length)];
      el.style.fontSize = (18 + Math.random()*18).toFixed(0) + "px";
      el.style.setProperty("--dx", (Math.random()*220 - 110).toFixed(0) + "px");
      el.style.animationDelay = (Math.random()*120).toFixed(0) + "ms";
      marquee.appendChild(el);
      el.addEventListener("animationend", ()=>el.remove());
    }
  }

  function shake(){
    marquee.classList.remove("shake");
    void marquee.offsetWidth;
    marquee.classList.add("shake");
  }

  function focusIME(){
    imeInput.focus({ preventScroll:true });
  }

  // ========= „Ç≤„Éº„É†Áä∂ÊÖã =========
  let playing = false;
  let composing = false;

  let timeLeft = 0;
  let timeMax = 0;
  let targetWords = 0;

  let currentWord = "";
  let idx = 0;

  let score = 0;
  let cleared = 0;
  let miss = 0;

  let timerId = null;
  let nextId = null;

  function applyModeUI(){
    customWrap.style.display = (modeEl.value === "custom") ? "flex" : "none";
  }

  function resolveMode(){
    const m = modeEl.value;
    if(m === "custom"){
      const t = Math.max(10, Math.min(9999, Number(customTimeEl.value || 120)));
      const g = Math.max(1, Math.min(9999, Number(customTargetEl.value || 30)));
      return { timeSec: t, target: g, label: "„Åã„Åô„Åü„ÇÄ" };
    }
    return MODE_PRESETS[m] ?? MODE_PRESETS.normal;
  }

  function updateHUD(){
    scoreEl.textContent = String(score);
    timeEl.textContent = playing ? String(timeLeft) : "--";
    clearedEl.textContent = String(cleared);
    missEl.textContent = String(miss);
    targetEl.textContent = String(targetWords);
    modeLabelEl.textContent = resolveMode().label;

    const ratio = (timeMax > 0) ? (timeLeft / timeMax) : 1;
    timeFill.style.transform = `scaleX(${Math.max(0, Math.min(1, ratio))})`;
  }

  function renderProgress(){
    doneEl.textContent = currentWord.slice(0, idx);
    todoEl.textContent = currentWord.slice(idx);
  }

  function pickWord(){
    const pool = getPool(categoryEl.value);
    if(pool.length === 0) return "„Çà„Åø„Åì„Åø„Åø„Åô";
    return pool[Math.floor(Math.random()*pool.length)];
  }

  function setNewWord(){
    currentWord = pickWord();
    idx = 0;
    imeInput.value = "";
    wordEl.textContent = currentWord;
    renderProgress();
  }

  function stopTimers(){
    if(timerId){ clearInterval(timerId); timerId=null; }
    if(nextId){ clearTimeout(nextId); nextId=null; }
  }

  function endGame(kind){
    playing = false;
    stopTimers();
    imeInput.value = "";
    updateHUD();

    if(kind === "clear"){
      setMessage("„Åè„Çä„ÅÇÔΩûÔºÅ");
      spawnHearts(18);
      playSE("ok");
    } else if(kind === "timeup"){
      setMessage("„Åò„Åã„Çì„Åé„Çå‚Ä¶ÔºÅ");
    } else {
      setMessage("");
    }
    startBtn.textContent = "„ÇÇ„ÅÜ„ÅÑ„Å£„Åã„ÅÑÔºÅ";
    stopBGM();
    focusIME();
  }

  function resetIdle(msg=""){
    playing = false;
    stopTimers();
    composing = false;

    currentWord = "";
    idx = 0;
    score = 0;
    cleared = 0;
    miss = 0;

    wordEl.textContent = "„Åô„Å∫„Éº„Åô „Åß „Åô„Åü„Éº„Å®ÔºÅ";
    doneEl.textContent = "";
    todoEl.textContent = "";
    setMessage(msg);
    startBtn.textContent = "„ÅÇ„Åù„Å≥„Å´„ÅÑ„ÅèÔºÅ";
    imeInput.value = "";
    updateHUD();
    stopBGM();
    focusIME();
  }

  async function startGame(){
    if(!DICT){
      alert("dictionary.json „Åå„Çà„ÇÅ„Å¶„Å™„ÅÑ‚Ä¶ Live Server„Åß„Å≤„Çâ„ÅÑ„Å¶„ÇãÔºü");
      return;
    }

    // „Åì„Åì„ÅåÈáçË¶ÅÔºö„Çπ„Çø„Éº„Éà„ÅÆ„ÇØ„É™„ÉÉ„ÇØ„ÅßÈü≥„ÇíËß£Á¶ÅÔºÜBGMÈñãÂßã
    await unlockAudio();
    if(SOUND.enabled) await playBGM();

    stopTimers();
    const conf = resolveMode();

    timeLeft = conf.timeSec;
    timeMax = conf.timeSec;
    targetWords = conf.target;

    score = 0;
    cleared = 0;
    miss = 0;

    playing = true;
    startBtn.textContent = "„Çä„Åõ„Å£„Å®ÔºÅ";
    setMessage("");

    setNewWord();
    updateHUD();
    focusIME();

    timerId = setInterval(()=>{
      if(!playing) return;
      timeLeft -= 1;
      if(timeLeft <= 0){
        timeLeft = 0;
        updateHUD();
        endGame("timeup");
        return;
      }
      updateHUD();
    }, 1000);
  }

  function validateInput(){
    if(!playing) return;
    if(composing) return;

    let v = (imeInput.value || "").replace(/\s+/g, "");

    if(v.length < idx){
      idx = v.length;
      renderProgress();
      return;
    }

    if(v.length > currentWord.length){
      v = v.slice(0, currentWord.length);
      imeInput.value = v;
    }

    for(let i=0;i<v.length;i++){
      if(v[i] === currentWord[i]) continue;

      miss += 1;
      score = Math.max(0, score - 5);
      shake();
      setPetFace("cry", 520);
      playSE("miss");

      imeInput.value = v.slice(0, i);
      v = imeInput.value;
      break;
    }

    idx = v.length;
    renderProgress();
    updateHUD();

    if(idx >= currentWord.length){
      cleared += 1;
      score += 20 + Math.min(40, Math.floor(currentWord.length * 2));
      popRandomPet();
      setPetFace("happy", 520);
      spawnHearts(9);
      playSE("ok");

      updateHUD();

      if(cleared >= targetWords){
        endGame("clear");
        return;
      }

      imeInput.value = "";
      idx = 0;
      renderProgress();

      if(nextId) clearTimeout(nextId);
      nextId = setTimeout(()=>{
        if(!playing) return;
        setNewWord();
        updateHUD();
        focusIME();
      }, 240);
    }
  }

  // ========= Êìç‰Ωú =========
  modeEl.addEventListener("change", ()=>{
    applyModeUI();
    updateHUD();
    focusIME();
  });

  categoryEl.addEventListener("change", ()=>{
    if(playing) setMessage("„Å§„Åé„ÅÆ„Åä„Å†„ÅÑ„Åã„Çâ „Åã„Å¶„Åî„Çä „ÅØ„Çì„Åà„ÅÑÔºÅ");
    else setMessage("");
    focusIME();
  });

  startBtn.addEventListener("click", async ()=>{
    if(!playing) await startGame();
    else resetIdle("");
  });

  document.addEventListener("keydown", async (e)=>{
    if(e.code === "Space"){
      e.preventDefault();
      if(!playing) await startGame();
      focusIME();
    } else if(playing){
      focusIME();
    }
  });

  imeInput.addEventListener("compositionstart", ()=>{ composing = true; });
  imeInput.addEventListener("compositionend", ()=>{
    composing = false;
    validateInput();
  });
  imeInput.addEventListener("input", ()=>{ validateInput(); });

  toggleBgBtn.addEventListener("click", ()=>{
    document.body.classList.toggle("has-bg");
    focusIME();
  });

  muteBtn.addEventListener("click", async ()=>{
    await unlockAudio();
    setSoundEnabled(!SOUND.enabled);
    if(SOUND.enabled && playing) await playBGM();
    focusIME();
  });

  testSeBtn.addEventListener("click", async ()=>{
    await unlockAudio();
    applyVolume();
    playSE("ok");
    setTimeout(()=>playSE("miss"), 220);
    focusIME();
  });

  volEl.addEventListener("input", ()=>{
    SOUND.volume = Math.max(0, Math.min(1, Number(volEl.value)/100));
    applyVolume();
  });

  // ========= Ëµ∑Âãï =========
  (async function boot(){
    renderPets();
    applyModeUI();
    SOUND.volume = Math.max(0, Math.min(1, Number(volEl.value)/100));
    applyVolume();

    try{
      await loadDictionary();
      resetIdle("„Åò„Åó„Çá „Çà„Åø„Åì„Åø „Åã„Çì„Çä„Çá„ÅÜÔºÅ");
    }catch(err){
      console.error(err);
      resetIdle("dictionary.json „Åå„Çà„ÇÅ„Å™„ÅÑ‚Ä¶ Live Server„Åß„Å≤„Çâ„ÅÑ„Å¶„Å≠");
      wordEl.textContent = "Ôºà„Çà„Åø„Åì„Åø „Åó„Å£„Å±„ÅÑÔºâ";
    }
  })();
</script>
</body>
</html>
